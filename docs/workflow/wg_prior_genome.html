<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="ipynb_website:version" content="0.9.7" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" type="text/css" href="../css/jt.css">

<link rel="stylesheet" type="text/css" href="../css/toc2.css">

<link href="../site_libs/jqueryui-1.11.4/jquery-ui.css">
<link rel="stylesheet" href="../site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>

<link rel="stylesheet"
      href="../site_libs/highlightjs/null.min.css"
      type="text/css" />

<script src="../site_libs/highlightjs/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>

<script src="../js/doc_toc.js"></script>
<script src="../js/docs.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
        },
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>
<script>
function filterDataFrame(id) {
    var input = document.getElementById("search_" + id);
    var filter = input.value.toUpperCase();
    var table = document.getElementById("dataframe_" + id);
    var tr = table.getElementsByTagName("tr");
    // Loop through all table rows, and hide those who don't match the search query
    for (var i = 1; i < tr.length; i++) {
        for (var j = 0; j < tr[i].cells.length; ++j) {
            var matched = false;
            if (tr[i].cells[j].innerHTML.toUpperCase().indexOf(filter) != -1) {
                tr[i].style.display = "";
                matched = true
                break;
            }
            if (!matched)
                tr[i].style.display = "none";
        }
    }
}
function sortDataFrame(id, n, dtype) {
    var table = document.getElementById("dataframe_" + id);
    var tb = table.tBodies[0]; // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
    var tr = Array.prototype.slice.call(tb.rows, 0); // put rows into array
    if (dtype === 'numeric') {
        var fn = function(a, b) { 
            return parseFloat(a.cells[n].textContent) <= parseFloat(b.cells[n].textContent) ? -1 : 1;
        }
    } else {
        var fn = function(a, b) {
            var c = a.cells[n].textContent.trim().localeCompare(b.cells[n].textContent.trim()); 
            return c > 0 ? 1 : (c < 0 ? -1 : 0) }
    }
    var isSorted = function(array, fn) {
        if (array.length < 2)
            return 1;
        var direction = fn(array[0], array[1]); 
        for (var i = 1; i < array.length - 1; ++i) {
            var d = fn(array[i], array[i+1]);
            if (d == 0)
                continue;
            else if (direction == 0)
                direction = d;
            else if (direction != d)
                return 0;
            }
        return direction;
    }
    var sorted = isSorted(tr, fn);
    if (sorted == 1 || sorted == -1) {
        // if sorted already, reverse it
        for(var i = tr.length - 1; i >= 0; --i)
            tb.appendChild(tr[i]); // append each row in order
    } else {
        tr = tr.sort(fn);
        for(var i = 0; i < tr.length; ++i)
            tb.appendChild(tr[i]); // append each row in order
    }
}
</script>

<script>
$( document ).ready(function(){
            var cfg={'threshold':3,     // depth of toc (number of levels)
             'number_sections': false,
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }
            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;
            // fire the main function with these parameters
            table_of_contents(cfg, st);
            var file=workflowDict[$("h1:first").attr("id")];
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            var docs=workflowArray;
            var docs_map=workflowArrayMap;
            var pos=workflowArray.indexOf(file);
            for (var a=pos;a>=0;a--){
                  $('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+file+'.html'+'"]').css("color","#126dce");
            for (var a=pos+1;a<docs.length;a++){
                  $(".toc #toc-level0").append('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>');
            }
            // $("#toc-header").hide(); // comment out because it prevents search bar from displaying
    });
</script>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');
  // mark it active
  menuAnchor.parent().addClass('active');
  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>
<div class="container-fluid main-container">
<!-- tabsets -->
<script src="../site_libs/navigation-1.1/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>



<title>Multi-tissue brain TWAS</title>

<style type = "text/css">
body {
  font-family: "Droid Sans";
  padding-top: 66px;
  padding-bottom: 40px;
}
</style>
</head>

<body>
<div tabindex="-1" id="notebook" class="border-box-sizing">
<div class="container" id="notebook-container">

<!-- code folding -->

<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">Multi-tissue brain TWAS</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
<li>
  <a href="../index.html">Overview</a>
</li>
        
<li>
  <a href="../writeup.html">Writeup</a>
</li>
        
<li>
  <a href="../analysis.html">Analysis</a>
</li>
        
<li>
  <a href="../workflow.html">Workflow</a>
</li>
        
      </ul>
        
<ul class="nav navbar-nav navbar-right">
<li>
   <a href="http://github.com/hsun3163/jnbinder"> <span class="fa fa-github"></span> </a>
</li>
</ul>
        
      </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Whole-genome-prior-computation">Whole genome prior computation<a class="anchor-link" href="#Whole-genome-prior-computation">&#182;</a></h1><p>This notebook implements a TWAS analysis workflow using multivariate susie.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Aim">Aim<a class="anchor-link" href="#Aim">&#182;</a></h2><p>TBD</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview-(TBD)">Overview (TBD)<a class="anchor-link" href="#Overview-(TBD)">&#182;</a></h2><p><strong>Objective</strong>: 
    To Compute the association between expression and SNP in prepare for TWAS analysis via genotype and multiple molecular phenotype</p>
<p><strong>Background</strong>:
    SNP can modulate the functional phenotypes both directly and by modulating the expression levels of genes. 
Therefore, the integration of expression measurements and a larger scale GWAS summary association statistics will help identify the genes associated with the targeted complex traits.</p>
<p><strong>Significance</strong>:
    By applying this method, new candidate genes whose expression level is significantly associated with complex traits can be used in prediction without actually going through the expensive gene expression measurement process. As a relatively small set of gene expression and genotyping, data can be used to impute the expression for a much larger set of phenotyped individuals from their SNP genotype data.</p>
<p><strong>Method</strong>:
    The imputed expression can then be viewed as a linear model of genotypes with _weights based on the correlation between SNPs and gene expression__ in the training data while accounting for linkage disequilibrium (LD) SNPs. We then correlated the imputed gene expression to the trait to perform a transcriptome-wide association study (TWAS) and identify significant expression-trait associations.</p>
<p>The weights are computed via multivariate susies, the accuracy of such weights are computed via by default 100 times five fold cross validation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pre-requisites">Pre-requisites<a class="anchor-link" href="#Pre-requisites">&#182;</a></h2><p>We provide a container image <code>docker://gaow/twas</code> that contains all software needed to run the pipeline. If you would like to configure it by yourself, please make sure you install the following software before running this notebook:</p>
<ul>
<li>tidyverse</li>
<li>PLINK</li>
<li>R package mashr</li>
<li>R package mmbr</li>
<li>Output from the following univatiate analysis pipeline: twas_fusion_susie.ipynb</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Input-and-Output(TBD)">Input and Output(TBD)<a class="anchor-link" href="#Input-and-Output(TBD)">&#182;</a></h1><h2 id="Input">Input<a class="anchor-link" href="#Input">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Command-interface-(TBD)">Command interface (TBD)<a class="anchor-link" href="#Command-interface-(TBD)">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Working-example">Working example<a class="anchor-link" href="#Working-example">&#182;</a></h1><p>A minimal working example (MWE) dataset that can be downloaded from the following link, which required access:<a href="https://drive.google.com/drive/u/0/folders/1N3PbH9hfv5eAikGHI58sXjVsssFkekWj">https://drive.google.com/drive/u/0/folders/1N3PbH9hfv5eAikGHI58sXjVsssFkekWj</a></p>
<p>To test the command, please download the mwe folder and run the first among the following command within the mwe/data folder.</p>
<p>The time it take to run this MWE shall be around 5 minutes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># Test the pipeline with MWE</span>


<span class="n">nohup</span> <span class="n">sos</span> <span class="n">run</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">GIT</span><span class="o">/</span><span class="n">neuro</span><span class="o">-</span><span class="n">twas</span><span class="o">/</span><span class="n">Workflow</span><span class="o">/</span><span class="n">wg_prior_genome.ipynb</span> <span class="n">mm_prior</span> <span class="n">\</span>
<span class="o">--</span><span class="n">molecular_pheno_dir</span> <span class="n">./molc_dir</span><span class="o">/</span>    <span class="n">\</span>
<span class="o">--</span><span class="n">rds_list</span> <span class="n">./rds_list_mwe</span>  <span class="n">\</span>
<span class="o">--</span><span class="n">wd</span>   <span class="n">./</span> <span class="n">\</span>
<span class="o">--</span><span class="n">name</span> <span class="s">&quot;geneTpmResidualsAgeGenderAdj_rename&quot;</span> <span class="n">\</span>
<span class="o">--</span><span class="n">constraint</span> <span class="s">&quot;Both&quot;</span> <span class="n">\</span>
<span class="o">--</span><span class="n">container</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">mfs</span><span class="o">/</span><span class="n">statgen</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">twas_latest.sif</span> <span class="o">&amp;</span>





<span class="c1">## Actual pipeline running.</span>

<span class="n">nohup</span> <span class="n">sos</span> <span class="n">run</span> <span class="o">~/</span><span class="n">GIT</span><span class="o">/</span><span class="n">neuro</span><span class="o">-</span><span class="n">twas</span><span class="o">/</span><span class="n">Workflow</span><span class="o">/</span><span class="n">wg_prior_genome.ipynb</span> <span class="n">mm_prior</span> <span class="n">\</span>
<span class="o">--</span><span class="n">molecular_pheno_dir</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">molc_dir</span>    <span class="n">\</span>
<span class="o">--</span><span class="n">rds_list</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">rds_list_test</span>  <span class="n">\</span>
<span class="o">--</span><span class="n">wd</span>   <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">test</span> <span class="n">\</span>
<span class="o">--</span><span class="n">name</span> <span class="s">&quot;geneTpmResidualsAgeGenderAdj_rename&quot;</span> <span class="n">\</span>
<span class="o">--</span><span class="n">container</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">mfs</span><span class="o">/</span><span class="n">statgen</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">twas_latest.sif</span> <span class="n">\</span>
<span class="o">--</span><span class="n">constraint</span> <span class="s">&quot;Both&quot;</span> <span class="o">-</span><span class="n">s</span> <span class="n">build</span> <span class="o">&amp;</span>



<span class="c1">## Actual pipeline running.</span>

<span class="n">nohup</span> <span class="n">sos</span> <span class="n">run</span> <span class="o">~/</span><span class="n">GIT</span><span class="o">/</span><span class="n">neuro</span><span class="o">-</span><span class="n">twas</span><span class="o">/</span><span class="n">Workflow</span><span class="o">/</span><span class="n">wg_prior_genome.ipynb</span> <span class="n">flash</span> <span class="n">\</span>
<span class="o">--</span><span class="n">molecular_pheno_dir</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">molc_dir</span>    <span class="n">\</span>
<span class="o">--</span><span class="n">rds_list</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">rds_list</span>  <span class="n">\</span>
<span class="o">--</span><span class="n">wd</span>   <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">merge</span> <span class="n">\</span>
<span class="o">--</span><span class="n">name</span> <span class="s">&quot;geneTpmResidualsAgeGenderAdj_rename&quot;</span> <span class="n">\</span>
<span class="o">--</span><span class="n">container</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">mfs</span><span class="o">/</span><span class="n">statgen</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">twas_latest.sif</span> <span class="n">\</span>
<span class="o">--</span><span class="n">constraint</span> <span class="s">&quot;Both&quot;</span> <span class="n">\</span>
<span class="o">-</span><span class="n">J</span> <span class="m">10</span> <span class="o">-</span><span class="n">q</span> <span class="n">csg</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">mfs</span><span class="o">/</span><span class="n">statgen</span><span class="o">/</span><span class="n">pbs_template</span><span class="o">/</span><span class="n">csg.yml</span> <span class="o">-</span><span class="n">s</span> <span class="n">build</span> <span class="o">&amp;</span>


<span class="c1">## Actual pipeline running.</span>

<span class="n">nohup</span> <span class="n">sos</span> <span class="n">run</span> <span class="o">~/</span><span class="n">GIT</span><span class="o">/</span><span class="n">neuro</span><span class="o">-</span><span class="n">twas</span><span class="o">/</span><span class="n">Workflow</span><span class="o">/</span><span class="n">wg_prior_genome.ipynb</span> <span class="n">flash</span> <span class="n">\</span>
<span class="o">--</span><span class="n">molecular_pheno_dir</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">molc_dir</span>    <span class="n">\</span>
<span class="o">--</span><span class="n">rds_list</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">rds_list</span>  <span class="n">\</span>
<span class="o">--</span><span class="n">wd</span>   <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hs3163</span><span class="o">/</span><span class="n">Project</span><span class="o">/</span><span class="n">Genome_prior</span><span class="o">/</span><span class="n">merge</span> <span class="n">\</span>
<span class="o">--</span><span class="n">name</span> <span class="s">&quot;geneTpmResidualsAgeGenderAdj_rename&quot;</span> <span class="n">\</span>
<span class="o">--</span><span class="n">container</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">mfs</span><span class="o">/</span><span class="n">statgen</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">twas_latest.sif</span> <span class="n">\</span>
<span class="o">--</span><span class="n">constraint</span> <span class="s">&quot;Both&quot;</span> <span class="n">\</span>
<span class="o">-</span><span class="n">s</span> <span class="n">build</span> <span class="o">&amp;</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_text output_error">
<pre>
Error in parse(text = x, srcfile = src): &lt;text&gt;:3:7: unexpected symbol
2: 
3: nohup sos
         ^
Traceback:
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Global-parameter-settings">Global parameter settings<a class="anchor-link" href="#Global-parameter-settings">&#182;</a></h1><p>The section outlined the parameters that can be set in the command interface.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[global]</span>
<span class="c1"># Path to a list of folders in which the rds are to be analysised</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">molecular_pheno_dir</span> <span class="o">=</span> <span class="n">path</span>

<span class="c1"># Path to a file that lists all the rds to be combined and analysis</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">rds_list</span> <span class="o">=</span> <span class="n">path</span>
<span class="c1"># Path to the work directory of this pipeline,where the output will be stored.</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">wd</span> <span class="o">=</span> <span class="n">path</span>
<span class="c1"># Specify the number of jobs per run.</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">job_size</span> <span class="o">=</span> <span class="m">2</span>
<span class="c1"># Container option for software to run the analysis: docker or singularity</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">container</span> <span class="o">=</span> <span class="s">&#39;gaow/twas&#39;</span>

<span class="c1"># Input data directory </span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">datadir</span> <span class="o">=</span> <span class="nf">path</span><span class="p">(</span><span class="s">&#39;{wd:a}/input&#39;</span><span class="p">)</span>
<span class="c1"># Work directory &amp; output directory</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">cwd</span> <span class="o">=</span> <span class="nf">path</span><span class="p">(</span><span class="s">&#39;{wd:a}/output&#39;</span><span class="p">)</span>
<span class="c1"># The filename prefix for output data</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">name</span> <span class="o">=</span> <span class="n">str</span>
<span class="c1"># handle N = per_chunk data-set in one job</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">per_chunk</span> <span class="o">=</span> <span class="m">1000</span>


<span class="c1"># Whether run flash with constriant or not,default both, (&#39;Constraint&#39;, &#39;No_Constraint&#39; , &#39;Both&#39;)</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">constraint</span> <span class="o">=</span> <span class="s">&#39;Both&#39;</span>


<span class="n">import</span> <span class="n">glob</span>
<span class="c1"># Get rds of interest to focus on.</span>
<span class="n">regions</span> <span class="o">=</span> <span class="nf">[x.strip</span><span class="p">()</span><span class="nf">.split</span><span class="p">()</span> <span class="n">for</span> <span class="n">x</span> <span class="n">in</span> <span class="nf">open</span><span class="p">(</span><span class="n">rds_list</span><span class="p">)</span><span class="nf">.readlines</span><span class="p">()</span> <span class="n">if</span> <span class="nf">x.strip</span><span class="p">()</span> <span class="n">and</span> <span class="n">not</span> <span class="nf">x.strip</span><span class="p">()</span><span class="nf">.startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span><span class="n">]</span>
<span class="n">molecular_pheno</span> <span class="o">=</span> <span class="nf">[x.strip</span><span class="p">()</span><span class="nf">.split</span><span class="p">()</span> <span class="n">for</span> <span class="n">x</span> <span class="n">in</span> <span class="nf">open</span><span class="p">(</span><span class="n">molecular_pheno_dir</span><span class="p">)</span><span class="nf">.readlines</span><span class="p">()</span> <span class="n">if</span> <span class="nf">x.strip</span><span class="p">()</span> <span class="n">and</span> <span class="n">not</span> <span class="nf">x.strip</span><span class="p">()</span><span class="nf">.startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span><span class="n">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[mm_prior_1</span><span class="p">,</span><span class="n">merge_1]</span>
<span class="n">input</span><span class="o">:</span>  <span class="n">molecular_pheno_dir</span><span class="p">,</span> <span class="n">for_each</span> <span class="o">=</span> <span class="s">&quot;regions&quot;</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&#39;{wd:a}/input/{_regions[0]}&#39;</span>

<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="n">job_size</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;4h&#39;</span><span class="p">,</span>  <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;6G&#39;</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{step_name}_{_output[0]:bn}&#39;</span>  

<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;$[ ]&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output}.stdout&#39;</span><span class="p">,</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="nf">library</span><span class="p">(</span><span class="s">&quot;dplyr&quot;</span><span class="p">)</span>
    <span class="nf">library</span><span class="p">(</span><span class="s">&quot;tibble&quot;</span><span class="p">)</span>
    <span class="nf">library</span><span class="p">(</span><span class="s">&quot;purrr&quot;</span><span class="p">)</span>
    <span class="nf">library</span><span class="p">(</span><span class="s">&quot;readr&quot;</span><span class="p">)</span>
    <span class="n">molecular_pheno</span> <span class="o">=</span> <span class="nf">read_delim</span><span class="p">(</span><span class="s">&quot;$[molecular_pheno_dir]&quot;</span><span class="p">,</span><span class="n">delim</span> <span class="o">=</span> <span class="s">&quot;\t&quot;</span><span class="p">)</span>
    <span class="n">molecular_pheno</span> <span class="o">=</span> <span class="n">molecular_pheno</span><span class="o">%&gt;%</span><span class="nf">mutate</span><span class="p">(</span><span class="n">dir</span> <span class="o">=</span> <span class="nf">map_chr</span><span class="p">(</span><span class="n">`#molc_pheno`</span><span class="p">,</span><span class="o">~</span><span class="nf">paste</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">`.x`</span><span class="p">,</span><span class="s">&quot;$[_regions[0]]&quot;</span><span class="p">),</span><span class="n">collapse</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">molecular_pheno</span><span class="p">)</span>
    <span class="c1"># For every condition read rds and extract the bhat and sbhat.</span>
    <span class="n">genos</span> <span class="o">=</span> <span class="nf">tibble</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">)</span>
    <span class="n">genos</span> <span class="o">=</span> <span class="n">genos</span><span class="o">%&gt;%</span><span class="nf">mutate</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="nf">map</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">~</span><span class="nf">readRDS</span><span class="p">(</span><span class="n">molecular_pheno[[.x</span><span class="p">,</span><span class="m">2</span><span class="n">]]</span><span class="p">)</span><span class="o">$</span><span class="n">bhat</span><span class="o">%&gt;%</span><span class="n">as.data.frame</span><span class="o">%&gt;%</span><span class="n">rownames_to_column</span><span class="p">),</span>
                           <span class="n">sbhat</span> <span class="o">=</span> <span class="nf">map</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">~</span><span class="nf">readRDS</span><span class="p">(</span><span class="n">molecular_pheno[[.x</span><span class="p">,</span><span class="m">2</span><span class="n">]]</span><span class="p">)</span><span class="o">$</span><span class="n">sbhat</span><span class="o">%&gt;%</span><span class="n">as.data.frame</span><span class="o">%&gt;%</span><span class="n">rownames_to_column</span><span class="p">))</span>

                      
    <span class="c1"># Join first two conditions</span>
    <span class="n">genos_join_bhat</span> <span class="o">=</span> <span class="nf">full_join</span><span class="p">((</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="nf">pull</span><span class="p">(</span><span class="n">bhat</span><span class="p">))</span><span class="n">[[1]]</span><span class="p">,(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="nf">pull</span><span class="p">(</span><span class="n">bhat</span><span class="p">))</span><span class="n">[[2]]</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="s">&quot;rowname&quot;</span><span class="p">)</span>
    <span class="n">genos_join_sbhat</span> <span class="o">=</span> <span class="nf">full_join</span><span class="p">((</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="nf">pull</span><span class="p">(</span><span class="n">sbhat</span><span class="p">))</span><span class="n">[[1]]</span><span class="p">,(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="nf">pull</span><span class="p">(</span><span class="n">sbhat</span><span class="p">))</span><span class="n">[[2]]</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="s">&quot;rowname&quot;</span><span class="p">)</span>
    
    <span class="c1"># If there are more conditions, join the rest</span>
    <span class="nf">if</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="m">2</span><span class="p">){</span>
    <span class="nf">for</span><span class="p">(</span><span class="n">j</span> <span class="n">in</span> <span class="m">3</span><span class="o">:</span><span class="n">n</span><span class="p">){</span>
    <span class="n">genos_join_bhat</span> <span class="o">=</span> <span class="nf">full_join</span><span class="p">(</span><span class="n">genos_join_bhat</span><span class="p">,(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="nf">pull</span><span class="p">(</span><span class="n">bhat</span><span class="p">))</span><span class="n">[[j]]</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="s">&quot;rowname&quot;</span><span class="p">)</span><span class="o">%&gt;%</span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">rowname</span><span class="p">)</span><span class="o">%&gt;%</span><span class="n">as.matrix</span>
    <span class="n">genos_join_sbhat</span> <span class="o">=</span> <span class="nf">full_join</span><span class="p">(</span><span class="n">genos_join_sbhat</span><span class="p">,(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="nf">pull</span><span class="p">(</span><span class="n">sbhat</span><span class="p">))</span><span class="n">[[j]]</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="s">&quot;rowname&quot;</span><span class="p">)</span><span class="o">%&gt;%</span><span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">rowname</span><span class="p">)</span><span class="o">%&gt;%</span><span class="n">as.matrix</span>
    <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sumstats</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">bhat</span><span class="o">=</span><span class="n">genos_join_bhat</span><span class="p">,</span> <span class="n">sbhat</span><span class="o">=</span><span class="n">genos_join_sbhat</span><span class="p">)</span>
    <span class="c1"># save the rds file</span>
    <span class="nf">saveRDS</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="s">&quot;$[_output]&quot;</span><span class="p">,</span> <span class="nf">list</span><span class="p">(</span><span class="n">sumstats</span> <span class="o">=</span> <span class="n">sumstats</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[mm_prior_2</span><span class="p">,</span><span class="n">extract_1]</span>

<span class="n">parameter</span><span class="o">:</span> <span class="n">seed</span> <span class="o">=</span> <span class="m">999</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">n_random</span> <span class="o">=</span> <span class="m">4</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">n_null</span> <span class="o">=</span> <span class="m">4</span>

<span class="n">input</span><span class="o">:</span> <span class="nf">glob.glob</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;{wd:a}/input/*.rds&#39;</span><span class="p">),</span> <span class="n">group_by</span> <span class="o">=</span> <span class="n">per_chunk</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&#39;{wd:a}/cache/{name}_{_index+1}.rds&#39;</span>

<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;1h&#39;</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;4G&#39;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output:bn}&#39;</span>
<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;${ }&quot;</span>
    <span class="nf">set.seed</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">seed</span><span class="p">})</span>
    <span class="n">matxMax</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">mtx</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">return</span><span class="p">(</span><span class="nf">arrayInd</span><span class="p">(</span><span class="nf">which.max</span><span class="p">(</span><span class="n">mtx</span><span class="p">),</span> <span class="nf">dim</span><span class="p">(</span><span class="n">mtx</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="n">remove_rownames</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">for </span><span class="p">(</span><span class="n">name</span> <span class="n">in</span> <span class="nf">names</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="nf">rownames</span><span class="p">(</span><span class="n">x[[name]]</span><span class="p">)</span> <span class="o">=</span> <span class="kc">NULL</span>
        <span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">extract_one_data</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">n_random</span><span class="p">,</span> <span class="n">n_null</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># If cannot read the input for some reason then we just skip it, assuming we have enough other data-sets to use.</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="nf">tryCatch</span><span class="p">(</span><span class="nf">readRDS</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span><span class="o">$</span><span class="n">sumstats</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="nf">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">))</span>
        <span class="nf">if </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span> <span class="nf">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="nf">abs</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">bhat</span><span class="o">/</span><span class="n">dat</span><span class="o">$</span><span class="n">sbhat</span><span class="p">)</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="nf">matxMax</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># strong effect samples</span>
        <span class="n">strong</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">bhat[max_idx[1]</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="n">]</span><span class="p">,</span> <span class="n">sbhat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">sbhat[max_idx[1]</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="n">]</span><span class="p">)</span>
        <span class="c1"># random samples excluding the top one</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">max_idx[1]</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="m">2</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="p">}</span> <span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">max_idx[1]</span> <span class="o">==</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">z</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">max_idx[1]</span><span class="m">-1</span><span class="p">)</span>
        <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="n">max_idx[1]</span><span class="m">-1</span><span class="p">),</span> <span class="p">(</span><span class="n">max_idx[1]</span><span class="m">+1</span><span class="p">)</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">random_idx</span> <span class="o">=</span> <span class="nf">sample</span><span class="p">(</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">n_random</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span>
        <span class="n">random</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">bhat[random_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="n">]</span><span class="p">,</span> <span class="n">sbhat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">sbhat[random_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="n">]</span><span class="p">)</span>
        <span class="c1"># null samples defined as |z| &lt; 2</span>
        <span class="n">null.id</span> <span class="o">=</span> <span class="nf">which</span><span class="p">(</span><span class="nf">apply</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="m">1</span><span class="p">,</span> <span class="n">max</span><span class="p">)</span> <span class="o">&lt;</span> <span class="m">2</span><span class="p">)</span>
        <span class="n">null_idx</span> <span class="o">=</span> <span class="nf">sample</span><span class="p">(</span><span class="n">null.id</span><span class="p">,</span> <span class="n">n_null</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="bp">F</span><span class="p">)</span>
        <span class="n">null</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">bhat[null_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="n">]</span><span class="p">,</span> <span class="n">sbhat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">sbhat[null_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="n">]</span><span class="p">)</span>
        <span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="n">infile</span><span class="p">,</span><span class="n">random</span> <span class="o">=</span> <span class="nf">remove_rownames</span><span class="p">(</span><span class="n">random</span><span class="p">),</span> <span class="n">null</span> <span class="o">=</span> <span class="nf">remove_rownames</span><span class="p">(</span><span class="n">null</span><span class="p">),</span> <span class="n">strong</span> <span class="o">=</span> <span class="nf">remove_rownames</span><span class="p">(</span><span class="n">strong</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="n">merge_data</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">one_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">return</span><span class="p">(</span><span class="n">one_data</span><span class="p">)</span>
      <span class="p">}</span> <span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">one_data</span><span class="p">))</span> <span class="p">{</span>
          <span class="nf">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
          <span class="nf">for </span><span class="p">(</span><span class="n">d</span> <span class="n">in</span> <span class="nf">names</span><span class="p">(</span><span class="n">one_data</span><span class="p">))</span> <span class="p">{</span>
              <span class="nf">for </span><span class="p">(</span><span class="n">s</span> <span class="n">in</span> <span class="nf">names</span><span class="p">(</span><span class="n">one_data[[d]]</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">res[[d]][[s]]</span> <span class="o">=</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">res[[d]][[s]]</span><span class="p">,</span> <span class="n">one_data[[d]][[s]]</span><span class="p">)</span>
              <span class="p">}</span>
          <span class="p">}</span>
          <span class="nf">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
    <span class="nf">for </span><span class="p">(</span><span class="n">f</span> <span class="n">in</span> <span class="nf">c</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input</span><span class="o">:</span><span class="n">r</span><span class="p">,}))</span> <span class="p">{</span>
      <span class="n">res</span> <span class="o">=</span> <span class="nf">merge_data</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nf">extract_one_data</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">$</span><span class="p">{</span><span class="n">n_random</span><span class="p">}))</span>
    <span class="p">}</span>
    <span class="nf">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">$</span><span class="p">{</span><span class="n">_output</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[mm_prior_3</span><span class="p">,</span><span class="n">extract_2]</span>
<span class="n">input</span><span class="o">:</span> <span class="n">group_by</span> <span class="o">=</span> <span class="s">&quot;all&quot;</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&#39;{wd:a}/output/{name}.rds&#39;</span>
<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;1h&#39;</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;6G&#39;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output:bn}&#39;</span>
<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;${ }&quot;</span>
    <span class="n">merge_data</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">one_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">return</span><span class="p">(</span><span class="n">one_data</span><span class="p">)</span>
      <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
          <span class="nf">for </span><span class="p">(</span><span class="n">d</span> <span class="n">in</span> <span class="nf">names</span><span class="p">(</span><span class="n">one_data</span><span class="p">))</span> <span class="p">{</span>
              <span class="nf">for </span><span class="p">(</span><span class="n">s</span> <span class="n">in</span> <span class="nf">names</span><span class="p">(</span><span class="n">one_data[[d]]</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">res[[d]][[s]]</span> <span class="o">=</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">res[[d]][[s]]</span><span class="p">,</span> <span class="n">one_data[[d]][[s]]</span><span class="p">)</span>
              <span class="p">}</span>
          <span class="p">}</span>
          <span class="nf">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
    <span class="nf">for </span><span class="p">(</span><span class="n">f</span> <span class="n">in</span> <span class="nf">c</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input</span><span class="o">:</span><span class="n">r</span><span class="p">,}))</span> <span class="p">{</span>
      <span class="n">dat</span> <span class="o">=</span> <span class="nf">merge_data</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="nf">readRDS</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="c1"># make output consistent in format with </span>
    <span class="c1"># https://github.com/stephenslab/gtexresults/blob/master/workflows/mashr_flashr_workflow.ipynb</span>
    <span class="nf">saveRDS</span><span class="p">(</span>
          <span class="nf">list</span><span class="p">(</span><span class="n">random.z</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">random</span><span class="o">$</span><span class="n">bhat</span><span class="o">/</span><span class="n">dat</span><span class="o">$</span><span class="n">random</span><span class="o">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">strong.z</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">strong</span><span class="o">$</span><span class="n">bhat</span><span class="o">/</span><span class="n">dat</span><span class="o">$</span><span class="n">strong</span><span class="o">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">null.z</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">null</span><span class="o">$</span><span class="n">bhat</span><span class="o">/</span><span class="n">dat</span><span class="o">$</span><span class="n">null</span><span class="o">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">random.b</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">random</span><span class="o">$</span><span class="n">bhat</span><span class="p">,</span>
           <span class="n">strong.b</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">strong</span><span class="o">$</span><span class="n">bhat</span><span class="p">,</span>
           <span class="n">null.b</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">null</span><span class="o">$</span><span class="n">bhat</span><span class="p">,</span>
           <span class="n">null.s</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">null</span><span class="o">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">random.s</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">random</span><span class="o">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">strong.s</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">strong</span><span class="o">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">file</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input</span><span class="o">:</span><span class="n">r</span><span class="p">,})</span>
              <span class="p">),</span>
          <span class="o">$</span><span class="p">{</span><span class="n">_output</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="c1"># Perform FLASH analysis (time estimate: 20min)</span>
<span class="n">[mm_prior_4</span><span class="p">,</span><span class="n">flash]</span>
<span class="c1"># default method for convex optimization</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">optmethod</span> <span class="o">=</span> <span class="s">&quot;mixSQP&quot;</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">flash_optmethod</span> <span class="o">=</span> <span class="s">&quot;mixSQP&quot;</span>

<span class="n">input</span><span class="o">:</span> <span class="n">f</span><span class="s">&#39;{wd:a}/output/{name}.rds&#39;</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&#39;{wd:a}/output/{name}.{constraint}.flash.rds&#39;</span>

<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;2h&#39;</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;8G&#39;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output:bn}&#39;</span>
<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output}.stdout&#39;</span><span class="p">,</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="nf">library</span><span class="p">(</span><span class="n">flashr</span><span class="p">)</span>
    <span class="nf">library</span><span class="p">(</span><span class="n">mixsqp</span><span class="p">)</span>
    <span class="nf">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">my_init_fn</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">flashr</span><span class="o">:::</span><span class="nf">udv_si</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
      <span class="n">pos_sum</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">ret</span><span class="o">$</span><span class="n">v[ret</span><span class="o">$</span><span class="n">v</span> <span class="o">&gt;</span> <span class="m">0</span><span class="n">]</span><span class="p">)</span>
      <span class="n">neg_sum</span> <span class="o">=</span> <span class="o">-</span><span class="nf">sum</span><span class="p">(</span><span class="n">ret</span><span class="o">$</span><span class="n">v[ret</span><span class="o">$</span><span class="n">v</span> <span class="o">&lt;</span> <span class="m">0</span><span class="n">]</span><span class="p">)</span>
      <span class="nf">if </span><span class="p">(</span><span class="n">neg_sum</span> <span class="o">&gt;</span> <span class="n">pos_sum</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">return</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="o">$</span><span class="n">u</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">ret</span><span class="o">$</span><span class="n">d</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="o">$</span><span class="n">v</span><span class="p">))</span>
      <span class="p">}</span> <span class="n">else</span>
      <span class="nf">return</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">flash_pipeline</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">init_fn</span> <span class="o">=</span> <span class="s">&quot;my_init_fn&quot;</span><span class="p">,</span> <span class="kc">...</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">## Non-negative FLASH suggested by Jason Willwerscheid for when the non-negative factor assumption is reasonable</span>
      <span class="c1">## cf: discussion section of</span>
      <span class="c1">## https://willwerscheid.github.io/MASHvFLASH/MASHvFLASHnn2.html</span>
      <span class="n">ebnm_fn</span> <span class="o">=</span> <span class="s">&quot;ebnm_ash&quot;</span>
      <span class="n">ebnm_param</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">mixcompdist</span> <span class="o">=</span> <span class="s">&quot;normal&quot;</span><span class="p">,</span>
                               <span class="n">optmethod</span> <span class="o">=</span> <span class="s">&quot;${flash_optmethod}&quot;</span><span class="p">),</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">mixcompdist</span> <span class="o">=</span> <span class="s">&quot;+uniform&quot;</span><span class="p">,</span>
                               <span class="n">optmethod</span> <span class="o">=</span> <span class="s">&quot;${flash_optmethod}&quot;</span><span class="p">))</span>
      <span class="c1">##</span>
      <span class="n">fl_g</span> <span class="o">&lt;-</span> <span class="n">flashr</span><span class="o">:::</span><span class="nf">flash_greedy_workhorse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">var_type</span> <span class="o">=</span> <span class="s">&quot;constant&quot;</span><span class="p">,</span>
                    <span class="n">ebnm_fn</span> <span class="o">=</span> <span class="n">ebnm_fn</span><span class="p">,</span>
                    <span class="n">ebnm_param</span> <span class="o">=</span> <span class="n">ebnm_param</span><span class="p">,</span>
                    <span class="n">init_fn</span> <span class="o">=</span> <span class="n">init_fn</span><span class="p">,</span>
                    <span class="n">stopping_rule</span> <span class="o">=</span> <span class="s">&quot;factors&quot;</span><span class="p">,</span>
                    <span class="n">tol</span> <span class="o">=</span> <span class="m">1e-3</span><span class="p">,</span>
                    <span class="n">verbose_output</span> <span class="o">=</span> <span class="s">&quot;odF&quot;</span><span class="p">)</span>
      <span class="n">fl_b</span> <span class="o">&lt;-</span> <span class="n">flashr</span><span class="o">:::</span><span class="nf">flash_backfit_workhorse</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">f_init</span> <span class="o">=</span> <span class="n">fl_g</span><span class="p">,</span>
                    <span class="n">var_type</span> <span class="o">=</span> <span class="s">&quot;constant&quot;</span><span class="p">,</span>
                    <span class="n">ebnm_fn</span> <span class="o">=</span> <span class="n">ebnm_fn</span><span class="p">,</span>
                    <span class="n">ebnm_param</span> <span class="o">=</span> <span class="n">ebnm_param</span><span class="p">,</span>
                    <span class="n">stopping_rule</span> <span class="o">=</span> <span class="s">&quot;factors&quot;</span><span class="p">,</span>
                    <span class="n">tol</span> <span class="o">=</span> <span class="m">1e-3</span><span class="p">,</span>
                    <span class="n">verbose_output</span> <span class="o">=</span> <span class="s">&quot;odF&quot;</span><span class="p">)</span>
      <span class="nf">return</span><span class="p">(</span><span class="n">fl_b</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">r1cov</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="n">x</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
    <span class="n">cov_from_factors</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">){</span>
       <span class="n">Ulist</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
       <span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">f</span><span class="p">)){</span>
         <span class="n">Ulist</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="n">Ulist</span><span class="p">,</span><span class="nf">list</span><span class="p">(</span><span class="nf">r1cov</span><span class="p">(</span><span class="n">f[i</span><span class="p">,</span><span class="n">]</span><span class="p">)))</span>
       <span class="p">}</span>
       <span class="nf">names</span><span class="p">(</span><span class="n">Ulist</span><span class="p">)</span> <span class="o">=</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">,(</span><span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
       <span class="nf">return</span><span class="p">(</span><span class="n">Ulist</span><span class="p">)</span>
     <span class="p">}</span>

    <span class="c1">## HS, is this function consistant with the ez model? </span>
    <span class="n">cov_flash</span> <span class="o">=</span> <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> <span class="n">non_singleton</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">save_model</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">#if(is.null(subset)) subset = 1:mashr:::n_effects(data)</span>
      <span class="c1">#b.center = apply(data$Bhat[subset,], 2, function(x) x - mean(x))</span>
      <span class="c1">## Only keep factors with at least two values greater than 1 / sqrt(n)</span>
    <span class="n">b.center</span> <span class="o">=</span> <span class="n">data</span><span class="o">$</span><span class="n">Bhat</span>
    <span class="n">find_nonunique_effects</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">thresh</span> <span class="o">&lt;-</span> <span class="m">1</span><span class="o">/</span><span class="nf">sqrt</span><span class="p">(</span><span class="nf">ncol</span><span class="p">(</span><span class="n">fl</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">))</span>
        <span class="n">vals_above_avg</span> <span class="o">&lt;-</span> <span class="nf">colSums</span><span class="p">(</span><span class="n">fl</span><span class="o">$</span><span class="n">ldf</span><span class="o">$</span><span class="n">f</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span>
        <span class="n">nonuniq_effects</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="n">vals_above_avg</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">)</span>
        <span class="nf">return</span><span class="p">(</span><span class="n">fl</span><span class="o">$</span><span class="n">ldf</span><span class="o">$</span><span class="n">f[</span><span class="p">,</span> <span class="n">nonuniq_effects</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="n">]</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="n">fmodel</span> <span class="o">=</span> <span class="nf">flash_pipeline</span><span class="p">(</span><span class="n">b.center</span><span class="p">)</span>
      <span class="nf">if </span><span class="p">(</span><span class="n">non_singleton</span><span class="p">)</span>
          <span class="n">flash_f</span> <span class="o">=</span> <span class="nf">find_nonunique_effects</span><span class="p">(</span><span class="n">fmodel</span><span class="p">)</span>
      <span class="n">else</span> 
          <span class="n">flash_f</span> <span class="o">=</span> <span class="n">fmodel</span><span class="o">$</span><span class="n">ldf</span><span class="o">$</span><span class="n">f</span>
      <span class="c1">## row.names(flash_f) = colnames(b)</span>
      <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">save_model</span><span class="p">))</span> <span class="nf">saveRDS</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">fmodel</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="n">flash_f</span><span class="p">),</span> <span class="n">save_model</span><span class="p">)</span>
      <span class="nf">if</span><span class="p">(</span><span class="nf">ncol</span><span class="p">(</span><span class="n">flash_f</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span><span class="p">){</span>
        <span class="n">U.flash</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="s">&quot;tFLASH&quot;</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="n">fmodel</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">fmodel</span><span class="o">$</span><span class="n">fitted_values</span> <span class="o">/</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">fmodel</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">))</span>
      <span class="p">}</span> <span class="n">else</span><span class="p">{</span>
        <span class="n">U.flash</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="nf">cov_from_factors</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">flash_f</span><span class="p">)),</span> <span class="s">&quot;FLASH&quot;</span><span class="p">),</span>
                    <span class="nf">list</span><span class="p">(</span><span class="s">&quot;tFLASH&quot;</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="n">fmodel</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">fmodel</span><span class="o">$</span><span class="n">fitted_values</span> <span class="o">/</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">fmodel</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">)))</span>
      <span class="p">}</span>
      <span class="nf">return</span><span class="p">(</span><span class="n">U.flash</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">##</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">readRDS</span><span class="p">(</span><span class="s">&quot;${_input}&quot;</span><span class="p">)</span>
    <span class="nf">if</span><span class="p">(</span><span class="s">&quot;${constraint}&quot;</span> <span class="o">==</span> <span class="s">&quot;Both&quot;</span> <span class="o">|</span><span class="s">&quot;${constraint}&quot;</span> <span class="o">==</span> <span class="s">&quot;No_Constraint&quot;</span> <span class="p">){</span>
    <span class="n">f.d</span> <span class="o">=</span> <span class="nf">flash_set_data</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">strong.z</span><span class="p">))</span>
    <span class="c1">#ycenter = apply(f.d$Y, 2, function(x) x - mean(x))</span>
    <span class="c1">#f.d$Y = ycenter</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nf">flash_pipeline</span><span class="p">(</span><span class="n">f.d</span><span class="p">,</span><span class="n">init_fn</span> <span class="o">=</span> <span class="s">&quot;udv_si&quot;</span><span class="p">)</span>
    <span class="p">}</span>              
    <span class="nf">if</span><span class="p">(</span><span class="s">&quot;${constraint}&quot;</span> <span class="o">==</span> <span class="s">&quot;Both&quot;</span><span class="p">){</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">strong.b</span><span class="p">,</span> <span class="n">dat</span><span class="o">$</span><span class="n">strong.s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="m">1E3</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">cov_flash</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">non_singleton</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="n">save_model</span> <span class="o">=</span> <span class="s">&quot;${_output}.model.rds&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">mashr</span><span class="o">:::</span><span class="nf">cov_from_factors</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">f</span><span class="o">$</span><span class="n">ldf</span><span class="o">$</span><span class="n">f</span><span class="p">)),</span> <span class="s">&quot;FLASH_NC&quot;</span><span class="p">),</span>
                <span class="nf">list</span><span class="p">(</span><span class="s">&quot;tFLASH_NC&quot;</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="n">f</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">f</span><span class="o">$</span><span class="n">fitted_values</span> <span class="o">/</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">f</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">)))</span>                                                     
    <span class="p">}</span><span class="n">else</span> <span class="nf">if </span><span class="p">(</span> <span class="s">&quot;${constraint}&quot;</span> <span class="o">==</span> <span class="s">&quot;Constraint&quot;</span> <span class="p">){</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">strong.b</span><span class="p">,</span> <span class="n">dat</span><span class="o">$</span><span class="n">strong.s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="m">1E3</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">cov_flash</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">non_singleton</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="n">save_model</span> <span class="o">=</span> <span class="s">&quot;${_output}.model.rds&quot;</span><span class="p">)</span>
    <span class="p">}</span><span class="n">else</span><span class="p">{</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="n">mashr</span><span class="o">:::</span><span class="nf">cov_from_factors</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">f</span><span class="o">$</span><span class="n">ldf</span><span class="o">$</span><span class="n">f</span><span class="p">)),</span> <span class="s">&quot;FLASH_NC&quot;</span><span class="p">),</span>
                <span class="nf">list</span><span class="p">(</span><span class="s">&quot;tFLASH_NC&quot;</span> <span class="o">=</span> <span class="nf">t</span><span class="p">(</span><span class="n">f</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">f</span><span class="o">$</span><span class="n">fitted_values</span> <span class="o">/</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">f</span><span class="o">$</span><span class="n">fitted_values</span><span class="p">)))</span> 
    <span class="p">}</span>                                                      
    <span class="nf">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">&quot;${_output}&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[mm_prior_5</span><span class="p">,</span><span class="n">mash_ed_1</span><span class="p">,</span> <span class="n">udr_ed_1</span><span class="p">,</span><span class="n">teem_ed_1</span><span class="p">,</span><span class="n">ed_1]</span>
<span class="n">parameter</span><span class="o">:</span> <span class="n">npc</span> <span class="o">=</span> <span class="m">3</span>
<span class="n">input</span><span class="o">:</span>  <span class="n">f</span><span class="s">&#39;{wd:a}/output/{name}.rds&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s">&#39;{wd:a}/output/{name}.{constraint}.flash.rds&#39;</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&#39;{_input[1]:n}.FL_PC{npc}.rds&#39;</span>

<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;36h&#39;</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;8G&#39;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output:bn}&#39;</span>
<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stdout&quot;</span><span class="p">,</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="nf">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">readRDS</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input[0]</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
    <span class="n">V</span> <span class="o">=</span> <span class="nf">cor</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">null.z</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">strong.z</span>
    <span class="n">X</span><span class="nf">[is.na</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="n">]</span> <span class="o">=</span> <span class="m">0</span>
    <span class="n">mash_data</span> <span class="o">=</span> <span class="nf">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">strong.b</span><span class="p">,</span> <span class="n">Shat</span><span class="o">=</span><span class="n">dat</span><span class="o">$</span><span class="n">strong.s</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">zero_Bhat_Shat_reset</span> <span class="o">=</span> <span class="m">1E3</span><span class="p">)</span>
    <span class="c1"># FLASH matrices</span>
    <span class="n">U.flash</span> <span class="o">=</span> <span class="nf">readRDS</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input[1]</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
    <span class="c1"># SVD matrices</span>
    <span class="n">U.pca</span> <span class="o">=</span> <span class="o">$</span><span class="p">{</span><span class="s">&quot;cov_pca(mash_data, %s)&quot;</span> <span class="o">% npc if npc &gt; 0 else &quot;list()&quot;}</span>
<span class="o">    # Emperical cov matrix</span>
<span class="o">    X.center = apply(X, 2, function(x) x - mean(x))</span>
<span class="o">    Ulist = c(U.flash, U.pca, list(&quot;XX&quot; = t(X.center) %*</span>% <span class="n">X.center</span> <span class="o">/</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">X.center</span><span class="p">)))</span>
    <span class="nf">saveRDS</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">mash_data</span> <span class="o">=</span> <span class="n">mash_data</span><span class="p">,</span> <span class="n">Ulist</span> <span class="o">=</span> <span class="n">Ulist</span><span class="p">,</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">),</span> <span class="o">$</span><span class="p">{</span><span class="n">_output</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[mash_ed_2]</span>
<span class="n">input</span><span class="o">:</span>  <span class="nf">output_from</span><span class="p">(</span><span class="s">&#39;mash_ed_1&#39;</span><span class="p">)</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&quot;{_input:n}.ED.rds&quot;</span>
<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;36h&#39;</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;8G&#39;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output:bn}&#39;</span>
<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stdout&quot;</span><span class="p">,</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="nf">library</span><span class="p">(</span><span class="n">mashr</span><span class="p">)</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">readRDS</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
    <span class="c1"># Denoised data-driven matrices</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="o">:::</span><span class="nf">bovy_wrapper</span><span class="p">(</span><span class="n">dat</span><span class="o">$</span><span class="n">mash_data</span><span class="p">,</span> <span class="n">dat</span><span class="o">$</span><span class="n">Ulist</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=$</span><span class="p">{</span><span class="n">_output</span><span class="o">:</span><span class="n">nr</span><span class="p">},</span> <span class="n">tol</span> <span class="o">=</span> <span class="m">1e-06</span><span class="p">)</span>
    <span class="c1"># format to input for simulation with DSC (current pipeline)</span>
    <span class="nf">saveRDS</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">U</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="n">Ulist</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="kc">pi</span><span class="p">,</span> <span class="n">loglik</span><span class="o">=</span><span class="nf">scan</span><span class="p">(</span><span class="s">&quot;${_output:nn}.ED_loglike.log&quot;</span><span class="p">)),</span> <span class="o">$</span><span class="p">{</span><span class="n">_output</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[udr_ed_2]</span>
<span class="n">input</span><span class="o">:</span>  <span class="nf">output_from</span><span class="p">(</span><span class="s">&#39;udr_ed_1&#39;</span><span class="p">)</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&quot;{_input:n}.UD_ED.rds&quot;</span>
<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;36h&#39;</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;8G&#39;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output:bn}&#39;</span>
<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stdout&quot;</span><span class="p">,</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="nf">library</span><span class="p">(</span><span class="n">udr</span><span class="p">)</span> <span class="c1"># udr commit 5265079 with changes to set lower bound on the eigenvalues</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">readRDS</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
    <span class="c1"># Denoised data-driven matrices</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nf">ud_init</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">X</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">V</span><span class="p">,</span> <span class="n">U_scaled</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(),</span> <span class="n">U_unconstrained</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">Ulist</span><span class="p">,</span> <span class="n">n_rank1</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">ud_fit</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">unconstrained.update</span> <span class="o">=</span> <span class="s">&quot;ed&quot;</span><span class="p">,</span> <span class="n">resid.update</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="m">5000</span><span class="p">),</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
    <span class="c1"># format to input for simulation with DSC (current pipeline)</span>
    <span class="nf">saveRDS</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">U</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="n">U</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="n">w</span><span class="p">,</span> <span class="n">loglik</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="n">loglik</span><span class="p">),</span> <span class="o">$</span><span class="p">{</span><span class="n">_output</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span></span><span class="n">[mm_prior_6</span><span class="p">,</span><span class="n">ed_2]</span>
<span class="n">method</span> <span class="o">=</span> <span class="n">[</span><span class="s">&quot;ed&quot;</span><span class="p">,</span><span class="s">&quot;teem&quot;</span><span class="n">]</span>
<span class="n">input</span><span class="o">:</span> <span class="n">for_each</span> <span class="o">=</span> <span class="s">&quot;method&quot;</span>
<span class="n">output</span><span class="o">:</span> <span class="n">f</span><span class="s">&quot;{_input:n}.{_method}.UD_ED.rds&quot;</span>
<span class="n">task</span><span class="o">:</span> <span class="n">trunk_workers</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">walltime</span> <span class="o">=</span> <span class="s">&#39;36h&#39;</span><span class="p">,</span> <span class="n">trunk_size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">mem</span> <span class="o">=</span> <span class="s">&#39;8G&#39;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{_output:bn}&#39;</span>
<span class="n">R</span><span class="o">:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;{_output:n}.stdout&quot;</span><span class="p">,</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
    <span class="nf">library</span><span class="p">(</span><span class="n">udr</span><span class="p">)</span> <span class="c1"># udr commit 5265079 with changes to set lower bound on the eigenvalues</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nf">readRDS</span><span class="p">(</span><span class="o">$</span><span class="p">{</span><span class="n">_input</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
    <span class="c1"># Denoised data-driven matrices</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="nf">ud_init</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">X</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">V</span><span class="p">,</span> <span class="n">U_scaled</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(),</span> <span class="n">U_unconstrained</span> <span class="o">=</span> <span class="n">dat</span><span class="o">$</span><span class="n">Ulist</span><span class="p">,</span> <span class="n">n_rank1</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nf">ud_fit</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">control</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">unconstrained.update</span> <span class="o">=</span> <span class="s">&quot;${_method}&quot;</span><span class="p">,</span> <span class="n">resid.update</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="m">5000</span><span class="p">),</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
    <span class="c1"># format to input for simulation with DSC (current pipeline)</span>
    <span class="nf">saveRDS</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">U</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="n">U</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="n">w</span><span class="p">,</span> <span class="n">loglik</span><span class="o">=</span><span class="n">res</span><span class="o">$</span><span class="n">loglik</span><span class="p">),</span> <span class="o">$</span><span class="p">{</span><span class="n">_output</span><span class="o">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<hr>
&copy 2020-2021 Hao Sun & Gao Wang, Department of Neurology, Columbia University
<p><small>Exported from <a href="http://github.com/hsun3163/jnbinder/blob/93314c88684ab4704a5db1f03c434d85b038a8f8/workflow/wg_prior_genome.ipynb"><code>workflow/wg_prior_genome.ipynb</code></a> committed by Gao Wang on Thu May 6 00:26:26 2021 <a href="http://github.com/hsun3163/jnbinder/commit/93314c88684ab4704a5db1f03c434d85b038a8f8">revision 1, 93314c8</a> <a href="https://stephenslab.github.io/ipynb-website/notes.html#Note-about-commit-ids"><span class="fa fa-question-circle"></span></a></small></p>
</div>
</div>
</body>
</html>
